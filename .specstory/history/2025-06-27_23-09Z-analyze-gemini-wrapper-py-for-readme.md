<!-- Generated by SpecStory -->

# Analyze gemini_wrapper.py for README (2025-06-27 23:09Z)

_**User**_

Analyze @gemini_wrapper.py and explain its purpose into @README.md 

---

_**Assistant**_

<think><details><summary>Thought Process</summary>I need to analyze the gemini_wrapper.py file that was attached and explain its purpose in README.md. Let me first read through the code to understand what it does.

Looking at the gemini_wrapper.py file:

1. It's a Python script that automates Google OAuth flow for the `gemini` CLI on macOS
2. It uses Chrome for Testing browser instead of the regular Chrome
3. It manages browser switching, OAuth automation via Playwright
4. It provides a wrapper around the gemini CLI to handle authentication automatically

Key functionality:
- Installs Chrome for Testing if not available using @puppeteer/browsers
- Temporarily sets Chrome for Testing as the default browser
- Launches Chrome in remote debugging mode 
- Runs the gemini CLI with given arguments
- Connects via Playwright-over-CDP to complete OAuth screens automatically
- Restores original default browser after completion
- Has retry logic for rate limits using gemini-2.5-flash model
- Provides both CLI interface and programmatic `ask()` function

The current README.md seems to just have some notes about parsing the Chrome for Testing installation output and setting the default browser.

I should update the README.md to properly explain what this tool does, how to use it, and its main features.</details></think>

---

I'll analyze the `gemini_wrapper.py` file and update the README.md to explain its purpose and functionality.

---

Read file: work/gemini_wrapper.py

---

<think><details><summary>Thought Process</summary>Now I have a good understanding of the gemini_wrapper.py file. Let me analyze its key features:

1. **Purpose**: It's an automation wrapper for Google's `gemini` CLI tool on macOS that handles OAuth authentication automatically
2. **Key Features**:
   - Installs Chrome for Testing if needed using @puppeteer/browsers
   - Temporarily switches default browser to Chrome for Testing  
   - Launches Chrome in remote debugging mode
   - Runs gemini CLI with given arguments
   - Uses Playwright to automate the OAuth flow (account selection, sign-in)
   - Restores original default browser after completion
   - Has rate limit detection and retry logic with gemini-2.5-flash model
   - Provides both CLI interface and programmatic API

3. **Main components**:
   - ChromeTestingManager: Handles Chrome for Testing installation/management
   - BrowserManager: Manages default browser switching via macdefaultbrowser
   - ChromeManager: Manages Chrome processes and CDP connection
   - UserResolver: Resolves user email from multiple sources (CLI arg, env var, settings)
   - OAuthAutomator: Handles the actual OAuth flow automation via Playwright
   - GeminiWrapper: Main orchestrator class
   - Functions: ask(), cli(), call_gemini_cli() for different usage patterns

4. **Requirements**:
   - macOS only
   - macdefaultbrowser utility
   - Playwright with chromium browser installed
   - Chrome for Testing (auto-installed)

Now I should update the README.md to properly explain this tool instead of the current content which is just some installation notes.</details></think>

---

```diff
- 
- If I run:
- 
- ```
- npx -y @puppeteer/browsers install chrome@stable --platform mac --path /Applications --quiet
- ```
- 
- we get:
- 
- ```
- Downloading chrome stable - 170 MB [====================] 100% 0.0s 
- chrome@138.0.7204.49 /Applications/chrome/mac-138.0.7204.49/chrome-mac-x64/Google Chrome for Testing.app/Contents/MacOS/Google Chrome for Testing
- ```
- 
- or:
- 
- ```
- chrome@138.0.7204.49 /Applications/chrome/mac-138.0.7204.49/chrome-mac-x64/Google Chrome for Testing.app/Contents/MacOS/Google Chrome for Testing
- ```
- 
- we need to parse out the final path. 
- 
- And we’ll be using that browser. We need to be setting the `macdefaultbrowser testing`
+ # Gemini CLI OAuth Automation Wrapper
+ 
+ An automated OAuth wrapper for Google's `gemini` CLI tool on macOS that eliminates the need for manual authentication steps.
+ 
+ ## Overview
+ 
+ The `gemini_wrapper.py` script automates the complete Google OAuth flow for the `gemini` CLI by:
+ 
+ 1. **Installing Chrome for Testing** if not available (using `@puppeteer/browsers`)
+ 2. **Temporarily switching default browser** to Chrome for Testing (using `macdefaultbrowser`)
+ 3. **Launching Chrome** in remote debugging mode (port 9222)
+ 4. **Running the `gemini` CLI** with your specified arguments
+ 5. **Automating OAuth screens** via Playwright-over-CDP - selecting your account and clicking "Sign in"
+ 6. **Restoring original browser** and optionally quitting Chrome when done
+ 
+ ## Key Features
+ 
+ ### 🔐 **Seamless Authentication**
+ - Automatically handles Google OAuth flow without manual intervention
+ - Supports specific user account selection via multiple configuration methods
+ - Remembers your preferred account across sessions
+ 
+ ### 🌐 **Smart Browser Management**
+ - Uses Chrome for Testing to avoid conflicts with your regular browser
+ - Automatically installs Chrome for Testing if needed
+ - Temporarily switches default browser for OAuth, then restores it
+ 
+ ### 🔄 **Rate Limit Handling**
+ - Detects API rate limits in real-time
+ - Automatically retries with `gemini-2.5-flash` model when rate limited
+ - Graceful failure handling with informative error messages
+ 
+ ### 📊 **Clean Response Extraction**
+ - Filters out authentication noise from gemini CLI output
+ - Returns clean model responses for programmatic use
+ - Preserves original CLI behavior for interactive use
+ 
+ ## Installation & Requirements
+ 
+ ### Prerequisites
+ 
+ **macOS only** - This tool requires macOS (Darwin) due to browser management dependencies.
+ 
+ #### Install required tools:
+ ```bash
+ # Install macdefaultbrowser utility
+ brew install macdefaultbrowser
+ 
+ # Install Playwright browsers (one-time setup)
+ playwright install chromium
+ ```
+ 
+ #### Dependencies (auto-installed via uv):
+ - `fire>=0.5.0` - CLI interface
+ - `playwright>=1.43.0` - Browser automation
+ - `requests>=2.31.0` - HTTP requests
+ - `platformdirs>=4.0.0` - Cross-platform directories
+ - `loguru>=0.7.0` - Logging
+ 
+ ## Usage
+ 
+ ### 1. CLI Interface (Direct Replacement)
+ 
+ Use exactly like the regular `gemini` CLI, but with automatic OAuth:
+ 
+ ```bash
+ # Ask a question
+ ./gemini_wrapper.py -p "Explain Python decorators"
+ 
+ # Use specific model
+ ./gemini_wrapper.py -m "gemini-pro" -p "Write a Python function"
+ 
+ # With verbose logging
+ ./gemini_wrapper.py --verbose -p "Hello world"
+ 
+ # Quit Chrome when done
+ ./gemini_wrapper.py --quit-chrome -p "What's the weather?"
+ ```
+ 
+ ### 2. Programmatic Interface
+ 
+ ```python
+ from gemini_wrapper import ask
+ 
+ # Simple question-answer
+ response = ask("Explain quantum computing in simple terms")
+ print(response)
+ 
+ # With specific user account
+ response = ask("Generate Python code", user="myemail@gmail.com")
+ print(response)
+ 
+ # With debug logging
+ response = ask("Help with debugging", verbose=True)
+ print(response)
+ ```
+ 
+ ### 3. Advanced Usage
+ 
+ ```python
+ import asyncio
+ from gemini_wrapper import call_gemini_cli
+ 
+ # Full control over gemini arguments
+ response = await call_gemini_cli(
+     gemini_args=["-m", "gemini-pro", "-p", "Your prompt here"],
+     user="specific@email.com",
+     verbose=True,
+     quit_chrome=True
+ )
+ ```
+ 
+ ## User Account Configuration
+ 
+ The wrapper resolves your Google account in this priority order:
+ 
+ 1. **`--user` CLI argument**: `./gemini_wrapper.py --user="you@gmail.com" -p "Hello"`
+ 2. **`GEMINI_CLI_USER` environment variable**: `export GEMINI_CLI_USER="you@gmail.com"`
+ 3. **Stored in settings.json**: Automatically saved from previous successful authentications
+ 4. **First available account**: If none specified, uses the first Google account found
+ 
+ ## How It Works
+ 
+ ### Browser Automation Flow
+ 
+ 1. **Setup Phase**:
+    - Checks if Chrome for Testing is installed, installs if needed
+    - Saves current default browser
+    - Sets Chrome for Testing as temporary default
+ 
+ 2. **Authentication Phase**:
+    - Launches Chrome in debugging mode (port 9222)
+    - Starts `gemini` CLI which opens OAuth URL in Chrome
+    - Playwright connects to Chrome via Chrome DevTools Protocol (CDP)
+    - Automatically clicks your account and "Sign in" button
+ 
+ 3. **Execution Phase**:
+    - Waits for OAuth success redirect
+    - Monitors gemini process for completion or rate limits
+    - Extracts clean response from mixed CLI output
+ 
+ 4. **Cleanup Phase**:
+    - Restores original default browser
+    - Optionally quits Chrome for Testing
+    - Returns clean response text
+ 
+ ### Rate Limit Handling
+ 
+ When the original request hits rate limits:
+ ```
+ gemini-wrapper detects: "429" or "Quota exceeded" or "rateLimitExceeded"
+ ↓
+ Automatically retries with: gemini -m "gemini-2.5-flash" [your-args]
+ ↓
+ Returns response or fails gracefully
+ ```
+ 
+ ## File Structure
+ 
+ ```
+ work/
+ ├── gemini_wrapper.py          # Main automation script
+ └── settings.json              # Auto-generated settings (Chrome path, user email)
+ ```
+ 
+ ## Settings Storage
+ 
+ Settings are automatically stored in:
+ - **Path**: `~/Library/Application Support/com.twardoch.chrometesting/settings.json`
+ - **Contents**: Chrome for Testing executable path, preferred user email
+ - **Auto-managed**: No manual editing required
+ 
+ ## Troubleshooting
+ 
+ ### Common Issues
+ 
+ **"Chrome CDP did not become available"**
+ - Another Chrome instance may be running without `--remote-debugging-port`
+ - Check if port 9222 is blocked: `curl http://localhost:9222/json/version`
+ - Look at debug logs: `/tmp/gemini_chrome_stderr.log`
+ 
+ **"macdefaultbrowser utility missing"**
+ ```bash
+ brew install macdefaultbrowser
+ ```
+ 
+ **Authentication fails**
+ - Enable verbose mode: `--verbose` to see detailed OAuth flow
+ - Check screenshots saved to: `oauth_error*.png`
+ - Verify your Google account has access to Gemini
+ 
+ **Rate limits persist**
+ - The wrapper automatically tries `gemini-2.5-flash` on rate limits
+ - Wait a few minutes before retrying
+ - Check your Gemini API quota in Google Cloud Console
+ 
+ ### Debug Mode
+ 
+ Enable verbose logging to see the full automation process:
+ 
+ ```bash
+ ./gemini_wrapper.py --verbose -p "Your question"
+ ```
+ 
+ This shows:
+ - Chrome installation and launch details
+ - Browser switching operations  
+ - OAuth flow step-by-step
+ - Gemini CLI output parsing
+ - Error details and screenshots
+ 
+ ## Security Notes
+ 
+ - **Browser isolation**: Uses Chrome for Testing, separate from your regular Chrome
+ - **Temporary access**: Only switches default browser during authentication
+ - **Local automation**: All OAuth automation happens locally via CDP
+ - **No credential storage**: No passwords or tokens are stored, only email preference
+ 
+ The wrapper provides a seamless, secure way to use Google's Gemini CLI without manual OAuth interruptions.
  
  
```

---

<think><details><summary>Thought Process</summary>Perfect! I've successfully analyzed the `gemini_wrapper.py` file and completely rewritten the README.md to provide a comprehensive explanation of its purpose and functionality. 

The new README covers:

1. **Overview** - What the tool does at a high level
2. **Key Features** - The main benefits (seamless auth, browser management, rate limiting, clean responses)
3. **Installation & Requirements** - Prerequisites and dependencies
4. **Usage** - Three different usage patterns (CLI, programmatic, advanced)
5. **User Account Configuration** - How user email resolution works
6. **How It Works** - Detailed explanation of the automation flow
7. **Rate Limit Handling** - How it deals with API limits
8. **File Structure** - What files are involved
9. **Settings Storage** - Where settings are stored
10. **Troubleshooting** - Common issues and solutions
11. **Debug Mode** - How to enable verbose logging
12. **Security Notes** - Security considerations

The README now accurately reflects what the `gemini_wrapper.py` script actually does - it's an OAuth automation wrapper for Google's Gemini CLI that uses Chrome for Testing and Playwright to handle authentication automatically.

This is much more useful than the previous content which was just some installation notes about parsing Chrome for Testing paths.</details></think>

---

I've successfully analyzed the `gemini_wrapper.py` file and completely rewritten the README.md to provide a comprehensive explanation of this OAuth automation tool.

## What `gemini_wrapper.py` Does

The script is a **sophisticated OAuth automation wrapper** for Google's `gemini` CLI on macOS that:

### 🎯 **Main Purpose**
Eliminates manual OAuth authentication steps when using Google's Gemini CLI by automating the entire browser-based authentication flow.

### 🔧 **Key Components**
- **ChromeTestingManager**: Installs and manages Chrome for Testing
- **BrowserManager**: Handles default browser switching via `macdefaultbrowser` 
- **ChromeManager**: Manages Chrome processes and CDP connections
- **OAuthAutomator**: Automates the actual OAuth flow using Playwright
- **UserResolver**: Resolves user email from multiple sources (CLI, env var, settings)

### 🌊 **Automation Flow**
1. Installs Chrome for Testing if needed (via `@puppeteer/browsers`)
2. Temporarily switches default browser to Chrome for Testing
3. Launches Chrome in remote debugging mode (port 9222)
4. Runs the `gemini` CLI which opens OAuth URL
5. Uses Playwright-over-CDP to automatically click your account and "Sign in"
6. Monitors for rate limits and retries with `gemini-2.5-flash` if needed
7. Extracts clean responses from CLI output
8. Restores original default browser

### 💡 **Smart Features**
- **Rate limit detection** with automatic fallback to faster models
- **Multi-source user configuration** (CLI arg, env var, stored settings)
- **Clean response extraction** filtering out authentication noise
- **Browser isolation** using Chrome for Testing to avoid conflicts
- **Comprehensive error handling** with debug screenshots

The tool provides both a **CLI interface** (drop-in replacement for `gemini`) and a **programmatic API** (`ask()` function) for seamless integration into workflows.

This is particularly useful for developers who frequently use Google's Gemini CLI and want to avoid the manual OAuth interruptions that normally occur.

---

